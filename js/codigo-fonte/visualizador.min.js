/**
 * visualizador.min.js
 * Versão combinada e minificada dos scripts do visualizador de código
 * Inclui: file-system.js, file-utils.js e file-viewer.js
 */

// Estrutura de arquivos
const fileSystem={index:{type:"file",path:"index.html"},"codigo-fonte.html":{type:"file",path:"codigo-fonte.html"},README:{type:"file",path:"README.md"},assets:{type:"folder",children:{img:{type:"folder",children:{logo:{type:"file",path:"assets/img/logo.png"}}}}},css:{type:"folder",children:{main:{type:"file",path:"css/main.css"},cadastro:{type:"file",path:"css/cadastro.css"},compras:{type:"file",path:"css/compras.css"},empenho:{type:"file",path:"css/empenho.css"},"lista-chaves":{type:"file",path:"css/lista-chaves.css"},recebimento:{type:"file",path:"css/recebimento.css"},"tratamento-dados":{type:"file",path:"css/tratamento-dados.css"}}},js:{type:"folder",children:{cadastro:{type:"file",path:"js/cadastro.js"},"calendario-fix":{type:"file",path:"js/calendario-fix.js"},"colunas-garantia":{type:"file",path:"js/colunas-garantia.js"},compras:{type:"file",path:"js/compras.js"},empenho:{type:"file",path:"js/empenho.js"},"filtro-cliente-fix":{type:"file",path:"js/filtro-cliente-fix.js"},"filtros-fix":{type:"file",path:"js/filtros-fix.js"},"firebase-config":{type:"file",path:"js/firebase-config.js"},"funcoes-corrigidas":{type:"file",path:"js/funcoes-corrigidas.js"},global:{type:"file",path:"js/global.js"},"processamento-arquivos-compras":{type:"file",path:"js/processamento-arquivos-compras.js"},"processamento-arquivos-tratamento":{type:"file",path:"js/processamento-arquivos-tratamento.js"},"processamento-arquivos":{type:"file",path:"js/processamento-arquivos.js"},"recebimento-dashboard":{type:"file",path:"js/recebimento-dashboard.js"},"recebimento-selecao":{type:"file",path:"js/recebimento-selecao.js"},recebimento:{type:"file",path:"js/recebimento.js"},recebimento_calendario_helper:{type:"file",path:"js/recebimento_calendario_helper.js"},recebimento_corrigido:{type:"file",path:"js/recebimento_corrigido.js"},"selector-init":{type:"file",path:"js/selector-init.js"},separacao:{type:"file",path:"js/separacao.js"},"tratamento-dados":{type:"file",path:"js/tratamento-dados.js"},"validacao-recebimento":{type:"file",path:"js/validacao-recebimento.js"},visualizacao:{type:"file",path:"js/visualizacao.js"},"codigo-fonte":{type:"folder",children:{"file-system":{type:"file",path:"js/codigo-fonte/file-system.js"},"file-viewer":{type:"file",path:"js/codigo-fonte/file-viewer.js"},"file-utils":{type:"file",path:"js/codigo-fonte/file-utils.js"},"visualizador.min":{type:"file",path:"js/codigo-fonte/visualizador.min.js"}}}}},"pages":{type:"folder",children:{cadastro:{type:"file",path:"pages/cadastro.html"},compras:{type:"file",path:"pages/compras.html"},empenho:{type:"file",path:"pages/empenho.html"},recebimento:{type:"file",path:"pages/recebimento.html"},separacao:{type:"file",path:"pages/separacao.html"},"tratamento-dados":{type:"file",path:"pages/tratamento-dados.html"}}}};function addFileToSystem(e){const t=e.split("/"),i=t.pop();let l=fileSystem;for(let e=0;e<t.length;e++){const i=t[e];l[i]||(l[i]={type:"folder",children:{}}),l=l[i].children}l[i]={type:"file",path:e}}window.fileSystem=fileSystem,window.addFileToSystem=addFileToSystem;

// Utilitários para manipulação de arquivos
const fileCache={};function getFileIcon(e){const t=e.split(".").pop().toLowerCase(),i={html:"fa-html5 text-danger",css:"fa-css3-alt text-primary",js:"fa-js text-warning",json:"fa-file-code text-secondary",md:"fa-markdown text-info",png:"fa-file-image text-success",jpg:"fa-file-image text-success",jpeg:"fa-file-image text-success",gif:"fa-file-image text-success",svg:"fa-file-image text-success",pdf:"fa-file-pdf text-danger",txt:"fa-file-alt text-secondary",xml:"fa-file-code text-primary"};return i[t]||"fa-file text-secondary"}function getLanguage(e){const t={js:"javascript",html:"html",css:"css",json:"json",md:"markdown",xml:"xml"};return t[e]||"plaintext"}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function getFileName(e){return e.split("/").pop()}function showNotification(e,t="info",i=3e3){const l=document.createElement("div");l.className=`alert alert-${t} position-fixed top-0 start-50 translate-middle-x mt-3`,l.style.zIndex="9999",l.innerHTML=e,document.body.appendChild(l),setTimeout(()=>{l.style.opacity="0",l.style.transition="opacity 0.5s ease",setTimeout(()=>{document.body.removeChild(l)},500)},i)}async function loadFilesInParallel(e){return Promise.all(e.map(e=>fetch(e).then(t=>{if(!t.ok)throw new Error(`Erro ao carregar ${e}: ${t.status}`);const i=t.headers.get("content-type");return i&&i.startsWith("image/")?t.blob().then(t=>{const i=URL.createObjectURL(t);return fileCache[e]={type:"image",data:i,blob:t},{path:e,loaded:!0}}):t.text().then(t=>(fileCache[e]={type:"text",data:t},{path:e,loaded:!0}))}).catch(t=>(console.error(`Erro ao carregar ${e}:`,t),{path:e,loaded:!1,error:t.message}))))}window.fileCache=fileCache,window.getFileIcon=getFileIcon,window.getLanguage=getLanguage,window.escapeHtml=escapeHtml,window.getFileName=getFileName,window.showNotification=showNotification,window.loadFilesInParallel=loadFilesInParallel;

// Visualizador de arquivos
let currentFilePath=null,fileTreeEl,codeViewerEl,codeContentEl,breadcrumbEl,copyBtn,downloadFileBtn,downloadBtn;function initElements(){fileTreeEl=document.getElementById("file-tree"),codeViewerEl=document.getElementById("code-viewer"),codeContentEl=document.getElementById("code-content"),breadcrumbEl=document.getElementById("breadcrumb"),copyBtn=document.getElementById("copy-btn"),downloadFileBtn=document.getElementById("download-file-btn"),downloadBtn=document.getElementById("download-btn")}function renderFileTree(e,t,i=""){for(const[l,n]of Object.entries(e)){if("type"===l||"path"===l)continue;const e=i?`${i}/${l}`:l,o="folder"===n.type,r=document.createElement("div");if(r.className=`file-item ${o?"folder-item":""}`,r.innerHTML=`\n            <i class="fas ${o?"fa-folder text-warning":getFileIcon(l)} me-2"></i>\n            ${l}\n        `,o){r.addEventListener("click",e=>{e.stopPropagation();const t=r.querySelector(".tree-indent");t&&(t.style.display="none"===t.style.display?"block":"none",r.querySelector("i").className=`fas ${"none"===t.style.display?"fa-folder":"fa-folder-open"} text-warning me-2`)});const t=document.createElement("div");t.className="tree-indent",renderFileTree(n.children,t,e),r.appendChild(t)}else r.addEventListener("click",()=>loadFile(n.path));t.appendChild(r)}}async function loadFile(e){try{currentFilePath=e,updateBreadcrumb(e),fileCache[e]?displayFileContent(e,fileCache[e]):(copyBtn.disabled=!0,downloadFileBtn.disabled=!0);const t=await fetch(e);if(!t.ok)throw new Error(`Erro ao carregar arquivo: ${t.statusText}`);const i=t.headers.get("content-type");if(i&&i.startsWith("image/")){const t=await t.blob(),i=URL.createObjectURL(t);fileCache[e]={type:"image",data:i,blob:t},displayFileContent(e,fileCache[e])}else{const t=await t.text();fileCache[e]={type:"text",data:t},displayFileContent(e,fileCache[e])}copyBtn.disabled=!1,downloadFileBtn.disabled=!1}catch(t){console.error(t),codeContentEl.innerHTML=`\n            <div class="alert alert-danger">\n                <i class="fas fa-exclamation-triangle"></i> \n                Erro ao carregar o arquivo: ${t.message}\n            </div>\n        `}}function displayFileContent(e,t){if("image"===t.type)codeContentEl.innerHTML=`\n            <div class="text-center py-3">\n                <img src="${t.data}" alt="${getFileName(e)}" class="img-preview">\n                <p class="mt-3">${getFileName(e)}</p>\n            </div>\n        `;else{const i=e.split(".").pop().toLowerCase(),l=t.data;["js","html","css","json","xml","md"].includes(i)?(codeContentEl.innerHTML=`<pre><code class="language-${getLanguage(i)}">${escapeHtml(l)}</code></pre>`,document.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e)})):codeContentEl.innerHTML=`<pre>${escapeHtml(l)}</pre>`}}function updateBreadcrumb(e){const t=e.split("/");breadcrumbEl.innerHTML="";const i=document.createElement("li");i.className="breadcrumb-item",i.innerHTML='<i class="fas fa-home"></i>',i.addEventListener("click",()=>{codeContentEl.innerHTML='\n            <div class="text-center py-5">\n                <i class="fas fa-code fa-5x text-muted mb-3"></i>\n                <h3>Selecione um arquivo para visualizar seu conteúdo</h3>\n            </div>\n        ',currentFilePath=null,copyBtn.disabled=!0,downloadFileBtn.disabled=!0,updateBreadcrumb("")}),breadcrumbEl.appendChild(i);let l="";for(let i=0;i<t.length;i++){const n=t[i];l+=i>0?"/"+n:n;const o=document.createElement("li");o.className=i===t.length-1?"breadcrumb-item active":"breadcrumb-item",o.textContent=n,i<t.length-1&&(o.style.cursor="pointer"),breadcrumbEl.appendChild(o)}}function downloadCurrentFile(){if(currentFilePath&&fileCache[currentFilePath]){const e=fileCache[currentFilePath],t=getFileName(currentFilePath);if("image"===e.type)fetch(e.data).then(e=>e.blob()).then(e=>{const i=window.URL.createObjectURL(e),l=document.createElement("a");l.style.display="none",l.href=i,l.download=t,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(i)});else{const i=new Blob([e.data],{type:"text/plain"}),l=window.URL.createObjectURL(i),n=document.createElement("a");n.style.display="none",n.href=l,n.download=t,document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(l)}}}function copyCurrentFile(){if(currentFilePath&&fileCache[currentFilePath]){const e=fileCache[currentFilePath];"text"===e.type&&navigator.clipboard.writeText(e.data).then(()=>{showNotification("Conteúdo copiado para a área de transferência!","success",2e3)}).catch(e=>{console.error("Erro ao copiar: ",e),showNotification("Erro ao copiar conteúdo","danger",2e3)})}}async function downloadFullProject(){try{const e=new JSZip,t=document.createElement("div");t.className="alert alert-info text-center position-fixed top-50 start-50 translate-middle",t.style.zIndex="9999",t.innerHTML='\n            <div class="spinner-border spinner-border-sm me-2" role="status"></div>\n            Compactando arquivos para download...\n        ',document.body.appendChild(t);const i=await(async function e(t,i=""){for(const[l,n]of Object.entries(t)){if("type"===l||"path"===l)continue;const t=i?`${i}/${l}`:l;if("folder"===n.type)e.folder(t),await e(n.children,t);else{if(!fileCache[n.path])try{const e=await fetch(n.path);if(e.ok){const t=e.headers.get("content-type");if(t&&t.startsWith("image/")){const t=await e.blob();fileCache[n.path]={type:"image",data:URL.createObjectURL(t),blob:t}}else{const t=await e.text();fileCache[n.path]={type:"text",data:t}}}}catch(e){console.error(`Erro ao carregar ${n.path}:`,e)}if(fileCache[n.path]){const i=fileCache[n.path];if("image"===i.type&&i.blob)e.file(t,i.blob);else if("text"===i.type)e.file(t,i.data);else if("image"===i.type)try{const i=await fetch(n.path);if(i.ok){const l=await i.blob();e.file(t,l)}}catch(e){console.error(`Erro ao carregar imagem ${n.path}:`,e)}}else try{const i=await fetch(n.path);if(i.ok){const l=await i.blob();e.file(t,l)}}catch(e){console.error(`Erro ao carregar ${n.path}:`,e)}}}}return await e(fileSystem),e.generateAsync({type:"blob"}));document.body.removeChild(t);const l=window.URL.createObjectURL(i),n=document.createElement("a");n.style.display="none",n.href=l,n.download="sistema-compras-recebimento.zip",document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(l),showNotification("Download iniciado!","success",3e3)}catch(e){console.error("Erro ao criar arquivo ZIP:",e),showNotification("Erro ao gerar o download do projeto","danger",3e3)}}function initFileViewer(){initElements(),renderFileTree(fileSystem,fileTreeEl),copyBtn.addEventListener("click",copyCurrentFile),downloadFileBtn.addEventListener("click",downloadCurrentFile),downloadBtn.addEventListener("click",downloadFullProject),preloadCommonFiles()}async function preloadCommonFiles(){loadFilesInParallel(["index.html","js/firebase-config.js","js/global.js","css/main.css"]).then(e=>{const t=e.filter(e=>e.loaded).length;t>0&&console.log(`Pré-carregados ${t} de 4 arquivos.`)})}window.initFileViewer=initFileViewer,window.loadFile=loadFile,window.downloadFullProject=downloadFullProject;
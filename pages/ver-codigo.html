<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Código - Sistema de Controle de Compras e Recebimento</title>
    <link rel="stylesheet" href="../css/main.css">
    <!-- Bootstrap para responsividade e componentes -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Prism.js para syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        .file-viewer {
            background: #2d3748;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .file-header {
            background: #4a5568;
            color: white;
            padding: 10px 15px;
            border-bottom: 1px solid #5a6175;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
        }
        .file-content pre {
            margin: 0;
            background: transparent !important;
            border: none;
            font-size: 12px;
            line-height: 1.4;
        }
        .file-content code {
            background: transparent !important;
        }
        .download-section {
            position: sticky;
            top: 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .expand-btn {
            background: none;
            border: none;
            color: #cbd5e0;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }
        .expand-btn:hover {
            color: white;
        }
        .file-tree {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .progress-container {
            margin-top: 10px;
            display: none;
        }
        #loadingProgress {
            height: 25px;
        }
        .file-count {
            color: #6c757d;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
<script src="https://lib.youware.com/youware-lib.1747145198.js" id="yourware-lib"></script><script src="https://lib.youware.com/youware-lib.1747145198.js" id="yourware-lib"></script></head>
<body>
    <header class="bg-dark text-white py-3">
        <div class="container">
            <div class="d-flex align-items-center">
                <a href="../index.html" class="text-white text-decoration-none me-3">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <h1 class="mb-0">Ver Código do Sistema</h1>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="mb-4">
                    <h2><i class="fas fa-folder-tree text-primary"></i> Estrutura do Projeto</h2>
                    <div class="file-tree" id="fileTree">Carregando estrutura...</div>
                </div>
                
                <div class="mb-4">
                    <h2><i class="fas fa-code text-primary"></i> Arquivos do Sistema <span class="file-count" id="fileCount"></span></h2>
                    <div id="filesContainer">
                        <div class="d-flex justify-content-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando arquivos...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="download-section">
                    <h3><i class="fas fa-download text-primary"></i> Download do Código</h3>
                    <p class="text-muted">Baixe todo o código fonte do sistema em um arquivo ZIP.</p>
                    
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" id="downloadBtn">
                            <i class="fas fa-download"></i> Baixar Código Completo
                        </button>
                    </div>
                    
                    <div class="progress-container" id="progressContainer">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="loadingProgress">
                                0%
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">Preparando arquivos para download...</small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5><i class="fas fa-info-circle text-info"></i> Informações do Sistema</h5>
                    <ul class="list-unstyled">
                        <li><strong>Tipo:</strong> Sistema Web</li>
                        <li><strong>Frontend:</strong> HTML, CSS, JavaScript</li>
                        <li><strong>Backend:</strong> Firebase</li>
                        <li><strong>Framework:</strong> Bootstrap 5</li>
                        <li><strong>Total de Arquivos:</strong> <span id="totalFiles">45</span></li>
                    </ul>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Dica:</strong> Este sistema é totalmente funcional e inclui todos os arquivos necessários para execução.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Prism.js para syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- JSZip para criar arquivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver para download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Estrutura real do sistema
        const systemFiles = {
            'index.html': {
                type: 'html',
                path: '../index.html'
            },
            'README.md': {
                type: 'markdown',
                path: '../README.md'
            },
            'assets/img/logo.png': {
                type: 'binary',
                path: '../assets/img/logo.png'
            },
            // CSS Files
            'css/main.css': {
                type: 'css',
                path: '../css/main.css'
            },
            'css/cadastro.css': {
                type: 'css',
                path: '../css/cadastro.css'
            },
            'css/compras.css': {
                type: 'css',
                path: '../css/compras.css'
            },
            'css/empenho.css': {
                type: 'css',
                path: '../css/empenho.css'
            },
            'css/lista-chaves.css': {
                type: 'css',
                path: '../css/lista-chaves.css'
            },
            'css/recebimento.css': {
                type: 'css',
                path: '../css/recebimento.css'
            },
            'css/tratamento-dados.css': {
                type: 'css',
                path: '../css/tratamento-dados.css'
            },
            // JavaScript Files
            'js/firebase-config.js': {
                type: 'javascript',
                path: '../js/firebase-config.js'
            },
            'js/global.js': {
                type: 'javascript',
                path: '../js/global.js'
            },
            'js/cadastro.js': {
                type: 'javascript',
                path: '../js/cadastro.js'
            },
            'js/calendario-fix.js': {
                type: 'javascript',
                path: '../js/calendario-fix.js'
            },
            'js/colunas-garantia.js': {
                type: 'javascript',
                path: '../js/colunas-garantia.js'
            },
            'js/compras.js': {
                type: 'javascript',
                path: '../js/compras.js'
            },
            'js/empenho.js': {
                type: 'javascript',
                path: '../js/empenho.js'
            },
            'js/filtro-cliente-fix.js': {
                type: 'javascript',
                path: '../js/filtro-cliente-fix.js'
            },
            'js/filtros-fix.js': {
                type: 'javascript',
                path: '../js/filtros-fix.js'
            },
            'js/funcoes-corrigidas.js': {
                type: 'javascript',
                path: '../js/funcoes-corrigidas.js'
            },
            'js/processamento-arquivos-compras.js': {
                type: 'javascript',
                path: '../js/processamento-arquivos-compras.js'
            },
            'js/processamento-arquivos-tratamento.js': {
                type: 'javascript',
                path: '../js/processamento-arquivos-tratamento.js'
            },
            'js/processamento-arquivos.js': {
                type: 'javascript',
                path: '../js/processamento-arquivos.js'
            },
            'js/recebimento-dashboard.js': {
                type: 'javascript',
                path: '../js/recebimento-dashboard.js'
            },
            'js/recebimento-selecao.js': {
                type: 'javascript',
                path: '../js/recebimento-selecao.js'
            },
            'js/recebimento.js': {
                type: 'javascript',
                path: '../js/recebimento.js'
            },
            'js/recebimento_calendario_helper.js': {
                type: 'javascript',
                path: '../js/recebimento_calendario_helper.js'
            },
            'js/recebimento_corrigido.js': {
                type: 'javascript',
                path: '../js/recebimento_corrigido.js'
            },
            'js/selector-init.js': {
                type: 'javascript',
                path: '../js/selector-init.js'
            },
            'js/separacao.js': {
                type: 'javascript',
                path: '../js/separacao.js'
            },
            'js/tratamento-dados.js': {
                type: 'javascript',
                path: '../js/tratamento-dados.js'
            },
            'js/validacao-recebimento.js': {
                type: 'javascript',
                path: '../js/validacao-recebimento.js'
            },
            'js/visualizacao.js': {
                type: 'javascript',
                path: '../js/visualizacao.js'
            },
            // HTML Pages
            'pages/cadastro.html': {
                type: 'html',
                path: '../pages/cadastro.html'
            },
            'pages/compras.html': {
                type: 'html',
                path: '../pages/compras.html'
            },
            'pages/empenho.html': {
                type: 'html',
                path: '../pages/empenho.html'
            },
            'pages/recebimento.html': {
                type: 'html',
                path: '../pages/recebimento.html'
            },
            'pages/separacao.html': {
                type: 'html',
                path: '../pages/separacao.html'
            },
            'pages/tratamento-dados.html': {
                type: 'html',
                path: '../pages/tratamento-dados.html'
            }
        };

        // Função para gerar árvore de arquivos
        function generateFileTree() {
            const tree = `src/
├── assets/
│   └── img/
│       └── logo.png
├── css/
│   ├── cadastro.css
│   ├── compras.css
│   ├── empenho.css
│   ├── lista-chaves.css
│   ├── main.css
│   ├── recebimento.css
│   └── tratamento-dados.css
├── js/
│   ├── cadastro.js
│   ├── calendario-fix.js
│   ├── colunas-garantia.js
│   ├── compras.js
│   ├── empenho.js
│   ├── filtro-cliente-fix.js
│   ├── filtros-fix.js
│   ├── firebase-config.js
│   ├── funcoes-corrigidas.js
│   ├── global.js
│   ├── processamento-arquivos-compras.js
│   ├── processamento-arquivos-tratamento.js
│   ├── processamento-arquivos.js
│   ├── recebimento-dashboard.js
│   ├── recebimento-selecao.js
│   ├── recebimento.js
│   ├── recebimento_calendario_helper.js
│   ├── recebimento_corrigido.js
│   ├── selector-init.js
│   ├── separacao.js
│   ├── tratamento-dados.js
│   ├── validacao-recebimento.js
│   └── visualizacao.js
├── pages/
│   ├── cadastro.html
│   ├── compras.html
│   ├── empenho.html
│   ├── recebimento.html
│   ├── separacao.html
│   ├── tratamento-dados.html
│   └── ver-codigo.html
├── README.md
└── index.html`;
            
            document.getElementById('fileTree').innerHTML = `<pre>${tree}</pre>`;
            document.getElementById('fileCount').textContent = `(${Object.keys(systemFiles).length} arquivos)`;
            document.getElementById('totalFiles').textContent = Object.keys(systemFiles).length;
        }

        // Função para obter extensão do arquivo
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        // Função para obter linguagem do Prism
        function getPrismLanguage(extension) {
            const langMap = {
                'html': 'html',
                'css': 'css',
                'js': 'javascript',
                'json': 'json',
                'md': 'markdown',
                'txt': 'text'
            };
            return langMap[extension] || 'text';
        }

        // Função para carregar e exibir arquivo
        async function loadAndDisplayFile(filename, config) {
            if (config.type === 'binary') {
                return `<div class="p-3 text-center text-muted">
                    <i class="fas fa-file-image fa-3x mb-2"></i>
                    <p>Arquivo binário (imagem): ${filename}</p>
                </div>`;
            }

            try {
                const response = await fetch(config.path);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const content = await response.text();
                const extension = getFileExtension(filename);
                const language = getPrismLanguage(extension);
                
                // Escapar HTML para evitar problemas de renderização
                const escapedContent = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                return `<pre><code class="language-${language}">${escapedContent}</code></pre>`;
            } catch (error) {
                console.error(`Erro ao carregar ${filename}:`, error);
                return `<div class="p-3 text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar arquivo: ${error.message}
                </div>`;
            }
        }

        // Função para criar elemento de arquivo
        function createFileElement(filename, config) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-viewer';
            
            const extension = getFileExtension(filename);
            const iconMap = {
                'html': 'fab fa-html5 text-danger',
                'css': 'fab fa-css3-alt text-primary', 
                'js': 'fab fa-js-square text-warning',
                'json': 'fas fa-brackets-curly text-info',
                'md': 'fab fa-markdown text-dark',
                'png': 'fas fa-image text-success'
            };
            
            const icon = iconMap[extension] || 'fas fa-file-code';
            
            fileDiv.innerHTML = `
                <div class="file-header">
                    <div>
                        <i class="${icon}"></i>
                        <strong>${filename}</strong>
                        <span class="badge bg-secondary ms-2">${extension.toUpperCase()}</span>
                    </div>
                    <button class="expand-btn" onclick="toggleFileContent(this)">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="file-content" style="display: none;">
                    <div class="p-3 text-center">
                        <div class="spinner-border spinner-border-sm text-light" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            `;
            
            return fileDiv;
        }

        // Função para alternar visualização do conteúdo
        async function toggleFileContent(button) {
            const content = button.closest('.file-viewer').querySelector('.file-content');
            const icon = button.querySelector('i');
            const filename = button.closest('.file-viewer').querySelector('strong').textContent;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                
                // Carregar conteúdo se ainda não foi carregado
                if (content.innerHTML.includes('spinner-border')) {
                    const config = systemFiles[filename];
                    const fileContent = await loadAndDisplayFile(filename, config);
                    content.innerHTML = fileContent;
                    
                    // Aplicar syntax highlighting
                    Prism.highlightAllUnder(content);
                }
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Função para carregar todos os arquivos
        async function loadAllFiles() {
            const container = document.getElementById('filesContainer');
            container.innerHTML = '';
            
            const fileEntries = Object.entries(systemFiles);
            
            for (const [filename, config] of fileEntries) {
                const fileElement = createFileElement(filename, config);
                container.appendChild(fileElement);
            }
        }

        // Função para download do código
        async function downloadCode() {
            const downloadBtn = document.getElementById('downloadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('loadingProgress');
            
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando Download...';
            progressContainer.style.display = 'block';
            
            try {
                const zip = new JSZip();
                const fileEntries = Object.entries(systemFiles);
                
                for (let i = 0; i < fileEntries.length; i++) {
                    const [filename, config] = fileEntries[i];
                    const progress = Math.round(((i + 1) / fileEntries.length) * 100);
                    
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    
                    try {
                        if (config.type === 'binary') {
                            // Para arquivos binários, usar blob
                            const response = await fetch(config.path);
                            if (response.ok) {
                                const blob = await response.blob();
                                zip.file(filename, blob);
                            }
                        } else {
                            // Para arquivos de texto
                            const response = await fetch(config.path);
                            if (response.ok) {
                                const content = await response.text();
                                zip.file(filename, content);
                            }
                        }
                    } catch (error) {
                        console.warn(`Erro ao processar ${filename}:`, error);
                        // Adicionar arquivo de erro para documentar o problema
                        zip.file(filename, `Erro ao processar arquivo: ${error.message}`);
                    }
                    
                    // Pequena pausa para permitir atualização da UI
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Adicionar esta própria página
                const currentPageResponse = await fetch(window.location.href);
                if (currentPageResponse.ok) {
                    const currentPageContent = await currentPageResponse.text();
                    zip.file('pages/ver-codigo.html', currentPageContent);
                }
                
                progressBar.textContent = 'Gerando arquivo ZIP...';
                
                // Gerar e baixar o ZIP
                const content = await zip.generateAsync({type: 'blob'});
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                saveAs(content, `sistema-compras-recebimento-${timestamp}.zip`);
                
                // Resetar interface
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar Código Completo';
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                
                // Mostrar mensagem de sucesso
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                alert.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Download concluído!</strong> O arquivo ZIP foi baixado com sucesso.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                downloadBtn.parentElement.appendChild(alert);
                
                // Remover alerta após 5 segundos
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Erro no download:', error);
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar Código Completo';
                progressContainer.style.display = 'none';
                
                // Mostrar mensagem de erro
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Erro no download!</strong> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                downloadBtn.parentElement.appendChild(alert);
            }
        }

        // Expor função globalmente para uso no HTML
        window.toggleFileContent = toggleFileContent;

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            generateFileTree();
            loadAllFiles();
            
            // Configurar botão de download
            document.getElementById('downloadBtn').addEventListener('click', downloadCode);
        });
    </script>
</body>
</html>